var XWiki=function(e){var t=e.widgets=e.widgets||{};t.SuggestPicker=Class.create({options:{showKey:false,showTooltip:false,showDeleteTool:true,enableSort:true,showClearTool:true,inputType:"hidden",listInsertionElement:null,listInsertionPosition:"after",acceptFreeText:false,onItemAdded:Prototype.emptyFunction,separator:","},initialize:function(e,t,n){this.removeItem=this.removeItem.bindAsEventListener(this);this.checkboxChanged=this.checkboxChanged.bindAsEventListener(this);this.options=Object.extend(Object.clone(this.options),n||{});this.input=$(e);this.suggest=t;this.inputName=this.input.name;if(!this.options.acceptFreeText){this.input.name=this.input.name+"__suggested"}else{this.input.addClassName("accept-value")}this.suggest.options.callback=this.acceptSuggestion.bind(this);this.list=new Element("ul",{"class":"accepted-suggestions"});var r;if(this.options.listInsertionElement){if(typeof this.options.listInsertionElement==="string"){r=this.input.up().down(this.options.listInsertionElement)}else{r=this.options.listInsertionElement}}if(!r){r=this.input}var i={};i[this.options.listInsertionPosition]=this.list;r.insert(i);if(this.options.showClearTool){this.clearTool=(new Element("a",{href:"#clearSelection","class":"clear-tool",title:"$services.localization.render('core.widgets.suggestPicker.deleteAll.tooltip')"})).update("$services.localization.render('core.widgets.suggestPicker.deleteAll')");this.clearTool.hide().observe("click",this.clearAcceptedList.bindAsEventListener(this));this.list.insert({after:this.clearTool})}this.initializeSelection()},initializeSelection:function(){this.input.readOnly=true;this.input.addClassName("loading");this.loadSelectedValue(this.input.value.split(this.options.separator),0)},loadSelectedValue:function(e,t){if(t>=e.length){this.input.readOnly=false;this.input.value="";this.input.removeClassName("loading");return}else{if(e[t].strip()==""){this.loadSelectedValue(e,t+1);return}}var n=false;var r=0;this.input.value=e[t];this.suggest.doAjaxRequests(-1,{parameters:{exactMatch:true},onSuccess:function(i){if(n){return}var s=this.suggest.parseResponse(i,this.suggest.sources[r])||[];for(var o=0;o<s.length;o++){if(this.matchesSelectedValue(e[t],s[o])){n=true;s[o].value=e[t];this.addItem(s[o]);return}}}.bind(this),onComplete:function(i){i.request.options.defaultValues.onComplete(i);if(++r>=this.suggest.sources.length){if(!n){this.addItem(this.getDefaultSuggestion(e[t]))}this.loadSelectedValue(e,t+1)}}.bind(this)})},matchesSelectedValue:function(e,t){return e==t.value},getDefaultSuggestion:function(e){return{id:e,value:e,info:e}},acceptSuggestion:function(e){if(!this.acceptAlreadyAddedItem(e.id||e.value)){this.addItem(e)}this.input.value=""},removeItem:function(e){var t=e.findElement("li");t.remove();this.notifySelectionChange(t);this.updateListTools();this.input.activate()},clearAcceptedList:function(e){e&&e.stop();this.list.update("");this.notifySelectionChange();this.updateListTools();this.input.activate()},checkboxChanged:function(e){var t=e.findElement("li");this.notifySelectionChange(t)},acceptAlreadyAddedItem:function(e){var t=$(this.getInputId(e));if(t){if(this.list&&!this.list.down("#"+this.getInputId(e).replace(/([ #;&,.+*~\':"!^$[\]()=>|\/])/g,"\\$1"))){return false}t.checked=true;this.notifySelectionChange(t.up("li")||t);return true}return false},addItem:function(e){if(!e){return}var t=this.displayItem(e);this.list.insert(t);this.options.onItemAdded(t.down("input"));this.notifySelectionChange(t);this.updateListTools()},displayItem:function(e){var t=this.createItemInput(e);var n=new Element("li");var r=(new Element("label",{"for":t.id})).insert({bottom:t});if(this.options.showKey){r.insert({bottom:(new Element("span",{"class":"key"})).update("["+t.value.escapeHTML()+"]")});r.insert({bottom:(new Element("span",{"class":"sep"})).update(" ")})}r.insert({bottom:(new Element("span",{"class":"value"})).update(e.value.escapeHTML())});n.insert(r);this.options.showDeleteTool&&n.insert(this.createDeleteTool());if(this.options.showTooltip&&e.info){n.appendChild((new Element("div",{"class":"tooltip"})).update(e.info))}return n},createItemInput:function(e){var t={type:this.options.inputType,name:this.inputName,id:this.getInputId(e.id||e.value),value:e.value||e.id};if(this.options.inputType=="checkbox"){t.checked="checked"}var n=new Element("input",t);n.observe("change",this.checkboxChanged);return n},createDeleteTool:function(){var e=(new Element("span",{"class":"delete-tool",title:"$services.localization.render('core.widgets.suggestPicker.delete.tooltip')"})).update("&times;").observe("click",this.removeItem);e.insert({top:(new Element("span",{"class":"hidden"})).update("[")});e.insert({bottom:(new Element("span",{"class":"hidden"})).update("]")});return e},updateListTools:function(){if(this.clearTool){if(this.list.childElements().length>1){this.clearTool.show()}else{this.clearTool.hide()}}if(this.options.enableSort&&this.list.childElements().length>1&&typeof Sortable!="undefined"){Sortable.create(this.list);this.list.addClassName("sortable")}},notifySelectionChange:function(e){Event.fire(document,"xwiki:multisuggestpicker:selectionchanged",{trigger:this.input,fieldName:this.inputName,changedElement:e})},getInputId:function(e){return this.inputName+"_"+e},detach:function(){this.clearTool&&this.clearTool.stopObserving("click").remove();this.list&&this.list.remove();this.input.name=this.inputName;this.input.removeClassName("accept-value")}});return e}(XWiki||{})
