<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc>
  <web>PhenoTips</web>
  <name>PatientToolsService</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>PhenoTips.PatientClass</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1330990815000</creationDate>
  <date>1331255871000</date>
  <contentUpdateDate>1331255871000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <template/>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>{{velocity}}{{html clean="false"}}
#if ($xcontext.action == 'get')
  #macro (dashIfEmpty $val)#if ("$!val" == '' || ($val.class.name.endsWith('Integer') &amp;&amp; $val &lt; 0) || ($val.class.name.endsWith('Double') &amp;&amp; $val.isNaN($val)))-#elseif ($val.class.name.endsWith('Integer'))$val#else$mathtool.roundTo(2, $val)#end#end
  $response.setContentType('application/json')
  #set ($age = $mathtool.toInteger("$!request.a"))
  #set ($sex = ("$!request.s" != 'F'))
##
  #set ($weight = $mathtool.toDouble("$!request.w"))
  #set ($height = $mathtool.toDouble("$!request.h"))
  #set ($head_c = $mathtool.toDouble("$!request.c"))
  #set ($ocd = $mathtool.toDouble("$!request.ocd"))
  #set ($icd = $mathtool.toDouble("$!request.icd"))
  #set ($pfl = $mathtool.toDouble("$!request.pfl"))
  #set ($ipd = $mathtool.toDouble("$!request.ipd"))
  #set ($ear = $mathtool.toDouble("$!request.ear"))
  #set ($hand = $mathtool.toDouble("$!request.hand"))
  #set ($palm = $mathtool.toDouble("$!request.palm"))
  #set ($foot = $mathtool.toDouble("$!request.foot"))
  #set ($ear_right = $mathtool.toDouble("$!request.ear_right"))
  #set ($hand_right = $mathtool.toDouble("$!request.hand_right"))
  #set ($palm_right = $mathtool.toDouble("$!request.palm_right"))
  #set ($foot_right = $mathtool.toDouble("$!request.foot_right"))
##
  #set ($valueMapping = [])
##
  #if ($weight != 0 &amp;&amp; $height != 0)
    #set($data = {'id' : 'bmi', 'value' : $!mathtool.roundTo(2, $services.percentile.getBMI($weight, $height))})
    #if ("$!request.a" != '')
       #set($discard = $data.put('percentile', $!services.percentile.getBMIPercentile($sex, $age, $weight, $height)))
       #set($discard = $data.put('deviation', $!services.percentile.getBMIStandardDeviation($sex, $age, $weight, $height)))
    #end
    #set($discard = $valueMapping.add($data))
  #end
  #if ("$!request.a" != '')
     #if ($weight != 0)
       #set($data = {'id' : 'weight',
                     'value' : $weight,
                     'percentile' : $!services.percentile.getWeightPercentile($sex, $age, $weight),
                     'deviation' : $!services.percentile.getWeightStandardDeviation($sex, $age, $weight)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ("$!height" != '' &amp;&amp; $height != 0)
       #set($data = {'id' : 'height',
                     'value' : $height,
                     'percentile' : $!services.percentile.getHeightPercentile($sex, $age, $height),
                     'deviation' : $!services.percentile.getHeightStandardDeviation($sex, $age, $height)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($head_c != 0)
       #set($data = {'id' : 'head_c',
                     'value' : $head_c,
                     'percentile' : $!services.percentile.getHCPercentile($sex, $age, $head_c),
                     'deviation' : $!services.percentile.getHCStandardDeviation($sex, $age, $head_c)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($ocd != 0)
       #set($data = {'id' : 'ocd',
                     'value' : $ocd,
                     'percentile' : $!services.percentile.getOuterCanthalDistancePercentile($sex, $age, $ocd),
                     'deviation' : $!services.percentile.getOuterCanthalDistanceStandardDeviation($sex, $age, $ocd)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($icd != 0)
       #set($data = {'id' : 'icd',
                     'value' : $icd,
                     'percentile' : $!services.percentile.getInnerCanthalDistancePercentile($sex, $age, $icd),
                     'deviation' : $!services.percentile.getInnerCanthalDistanceStandardDeviation($sex, $age, $icd)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($pfl != 0)
       #set($data = {'id' : 'pfl',
                     'value' : $pfl,
                     'percentile' : $!services.percentile.getPalpebralFissureLengthPercentile($sex, $age, $pfl),
                     'deviation' : $!services.percentile.getPalpebralFissureLengthStandardDeviation($sex, $age, $pfl)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($ipd != 0)
       #set($data = {'id' : 'ipd',
                     'value' : $ipd,
                     'percentile' : $!services.percentile.getInterpupilaryDistancePercentile($sex, $age, $ipd),
                     'deviation' : $!services.percentile.getInterpupilaryDistanceStandardDeviation($sex, $age, $ipd)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($ear != 0)
       #set($data = {'id' : 'ear',
                     'value' : $ear,
                     'percentile' : $!services.percentile.getEarLengthPercentile($sex, $age, $ear),
                     'deviation' : $!services.percentile.getEarLengthStandardDeviation($sex, $age, $ear)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($hand != 0)
       #set($data = {'id' : 'hand',
                     'value' : $hand,
                     'percentile' : $!services.percentile.getHandLengthPercentile($sex, $age, $hand),
                     'deviation' : $!services.percentile.getHandLengthStandardDeviation($sex, $age, $hand)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($palm != 0)
       #set($data = {'id' : 'palm',
                     'value' : $palm,
                     'percentile' : $!services.percentile.getPalmLengthPercentile($sex, $age, $palm),
                     'deviation' : $!services.percentile.getPalmLengthStandardDeviation($sex, $age, $palm)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($foot != 0)
       #set($data = {'id' : 'foot',
                     'value' : $foot,
                     'percentile' : $!services.percentile.getFootLengthPercentile($sex, $age, $foot),
                     'deviation' : $!services.percentile.getFootLengthStandardDeviation($sex, $age, $foot)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($ear_right != 0)
       #set($data = {'id' : 'ear_right',
                     'value' : $ear_right,
                     'percentile' : $!services.percentile.getEarLengthPercentile($sex, $age, $ear_right),
                     'deviation' : $!services.percentile.getEarLengthStandardDeviation($sex, $age, $ear_right)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($hand_right != 0)
       #set($data = {'id' : 'hand_right',
                     'value' : $hand_right,
                     'percentile' : $!services.percentile.getHandLengthPercentile($sex, $age, $hand_right),
                     'deviation' : $!services.percentile.getHandLengthStandardDeviation($sex, $age, $hand_right)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($palm_right != 0)
       #set($data = {'id' : 'palm_right',
                     'value' : $palm_right,
                     'percentile' : $!services.percentile.getPalmLengthPercentile($sex, $age, $palm_right),
                     'deviation' : $!services.percentile.getPalmLengthStandardDeviation($sex, $age, $palm_right)
       })
       #set($discard = $valueMapping.add($data))
     #end
     #if ($foot_right != 0)
       #set($data = {'id' : 'foot_right',
                     'value' : $foot_right,
                     'percentile' : $!services.percentile.getFootLengthPercentile($sex, $age, $foot_right),
                     'deviation' : $!services.percentile.getFootLengthStandardDeviation($sex, $age, $foot_right)
       })
       #set($discard = $valueMapping.add($data))
     #end
  #end##age
  {
  #foreach ($entry in $valueMapping)
    #if ("$!entry.value" == '' || $entry.percentile &lt; 0)
      #set ($dValue = '-')
    #else
      #set ($pValue = $entry.percentile)
      #set ($sdValue = $entry.deviation)
      #set ($dValue = "${pValue}#if($pValue%10==1)&lt;sup&gt;st&lt;/sup&gt;#elseif($pValue%10==2)&lt;sup&gt;nd&lt;/sup&gt;#elseif($pValue%10==3)&lt;sup&gt;rd&lt;/sup&gt;#{else}&lt;sup&gt;th&lt;/sup&gt;#end pctl (#if ($sdValue &gt;= 0)+#end${mathtool.roundTo(2, $sdValue)}SD)")
    #end
    "$entry.id" : {
        "value" : "#dashIfEmpty($entry.value)",
        "percentile" : "#dashIfEmpty($entry.percentile)",
        "deviation" : "#dashIfEmpty($entry.deviation)",
        "valCategory" : "$!services.percentile.getFuzzyValue($entry.deviation)",
        "evaluation" : "$dValue"
    }#if($foreach.hasNext()),

    #end
  #end

  }
#end{{/html}}{{/velocity}}
</content>
</xwikidoc>
